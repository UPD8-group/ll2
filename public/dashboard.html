<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Listing Lens — Analyse a listing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream:#f0ebe3; --cream-dark:#e8e0d5; --cream-mid:#ede7de;
      --white:#ffffff; --ink:#1a1714; --ink-sec:#5c5650; --ink-muted:#a09890;
      --green:#2cb67d; --green-dark:#1d9963; --green-pale:#e8f7f0;
      --green-border:rgba(44,182,125,0.25); --blob:#c8dfd4;
      --border:rgba(0,0,0,0.08); --border-med:rgba(0,0,0,0.13);
      --red:#dc2626; --red-pale:#fef2f2;
      --shadow-sm:0 1px 3px rgba(0,0,0,0.07);
      --shadow-md:0 4px 16px rgba(0,0,0,0.09);
      --shadow-lg:0 16px 48px rgba(0,0,0,0.13);
      --r:16px; --font:'DM Sans',sans-serif; --display:'Bricolage Grotesque',sans-serif;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html{scroll-behavior:smooth;}
    body{font-family:var(--font);background:var(--cream);color:var(--ink);-webkit-font-smoothing:antialiased;min-height:100vh;display:flex;flex-direction:column;}

    /* ── NAV ── */
    nav{position:sticky;top:0;z-index:200;background:rgba(240,235,227,0.92);backdrop-filter:blur(18px);border-bottom:1px solid var(--border);}
    .nav-inner{max-width:1160px;margin:0 auto;padding:0 32px;display:flex;align-items:center;height:62px;gap:24px;}
    .logo{display:flex;align-items:center;gap:9px;text-decoration:none;flex-shrink:0;}
    .logo-mark{width:30px;height:30px;background:var(--ink);border-radius:8px;display:flex;align-items:center;justify-content:center;}
    .logo-mark svg{width:14px;height:14px;}
    .logo-name{font-family:var(--display);font-weight:800;font-size:15px;letter-spacing:-0.4px;color:var(--ink);}
    .nav-badge{font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--ink-muted);background:var(--white);border:1px solid var(--border);padding:4px 11px;border-radius:100px;margin-left:4px;}
    .nav-right{margin-left:auto;display:flex;align-items:center;gap:14px;}
    .nav-no-account{font-size:12px;color:var(--ink-muted);display:flex;align-items:center;gap:6px;}
    .nav-no-account svg{width:14px;height:14px;stroke:var(--green-dark);stroke-width:2;fill:none;}
    .btn-nav{font-size:13px;font-weight:600;color:#fff;text-decoration:none;padding:8px 18px;background:var(--ink);border-radius:100px;transition:all 0.2s;}
    .btn-nav:hover{background:#2d2926;}
    @media(max-width:640px){.nav-badge,.nav-no-account{display:none;}}

    /* ── LAYOUT ── */
    main{flex:1;}
    .layout{max-width:1160px;margin:0 auto;padding:24px 32px;display:grid;grid-template-columns:290px minmax(0,1fr);gap:20px;align-items:start;}
    @media(max-width:900px){.layout{grid-template-columns:1fr;}}
    @media(max-width:600px){.layout{padding:16px;}}

    /* ── SIDEBAR ── */
    .sidebar{position:sticky;top:82px;display:flex;flex-direction:column;gap:14px;}

    /* Joe card */
    .joe-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow-sm);}
    .joe-img{width:100%;height:200px;object-fit:cover;object-position:top center;display:block;filter:saturate(0.88) contrast(1.04);}
    .joe-card-body{padding:14px 16px;}
    .joe-name-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
    .joe-name{font-family:var(--display);font-size:15px;font-weight:800;color:var(--ink);letter-spacing:-0.3px;}
    .joe-role-tag{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--green-dark);background:var(--green-pale);padding:3px 8px;border-radius:5px;}
    .joe-quote{font-size:12px;color:var(--ink-sec);line-height:1.6;font-style:italic;border-left:2px solid var(--green);padding-left:9px;}

    /* Scan card */
    .scan-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:20px;box-shadow:var(--shadow-sm);}
    .card-label{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--ink-muted);margin-bottom:12px;}

    /* Price row */
    .price-row{display:flex;align-items:baseline;gap:8px;margin-bottom:16px;}
    .price-amount{font-family:var(--display);font-size:40px;font-weight:800;color:var(--ink);letter-spacing:-2px;line-height:1;}
    .price-sub{font-size:13px;color:var(--ink-sec);line-height:1.45;}

    /* Scan button */
    .btn-scan{width:100%;display:flex;align-items:center;justify-content:center;gap:9px;background:var(--ink);color:#fff;font-family:var(--font);font-size:14px;font-weight:600;padding:13px 20px;border:none;border-radius:10px;cursor:pointer;transition:all 0.2s;letter-spacing:-0.1px;}
    .btn-scan:hover{background:#2d2926;transform:translateY(-1px);box-shadow:var(--shadow-md);}
    .btn-scan svg{width:16px;height:16px;flex-shrink:0;}
    .btn-scan:disabled{background:#9ca3af;cursor:default;transform:none;box-shadow:none;}
    .upload-hint{font-size:12px;color:var(--ink-muted);line-height:1.6;margin-top:10px;}

    /* Payment */
    #payment-wrap{display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
    #card-element{padding:12px;background:var(--cream);border:1px solid var(--border-med);border-radius:9px;margin-bottom:10px;}
    .btn-pay{width:100%;padding:13px;background:var(--green-dark);color:#fff;font-family:var(--font);font-size:14px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.15s;}
    .btn-pay:hover{background:#15803d;}
    .btn-pay:disabled{opacity:0.5;cursor:default;}

    /* Session reports */
    .session-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow-sm);}
    .case-list{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .case-item{padding:10px 12px;border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all 0.15s;background:var(--cream);}
    .case-item:hover{border-color:var(--green);background:var(--green-pale);}
    .case-item.active{border-color:var(--green);background:var(--green-pale);box-shadow:0 0 0 1px var(--green);}
    .case-title{font-size:12px;font-weight:600;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;}
    .case-meta{font-size:11px;color:var(--ink-muted);}
    .no-cases{font-size:12px;color:var(--ink-muted);font-style:italic;margin-top:8px;}

    /* ── SCANNING SIDEBAR STATE ── */
    .sidebar.scanning .scan-card{background:var(--cream-dark);}
    .sidebar.scanning .btn-scan{background:#9ca3af;cursor:default;transform:none;box-shadow:none;}
    .sidebar.scanning .idle-content{display:none;}
    .progress-block{display:none;}
    .sidebar.scanning .progress-block{display:block;}

    /* ── COUNTER ── */
    .counter-wrap{text-align:center;padding:8px 0 20px;}
    .counter-ring-svg{display:block;margin:0 auto 16px;transform:rotate(-90deg);}
    .counter-track{fill:none;stroke:rgba(0,0,0,0.07);stroke-width:6;}
    .counter-fill{fill:none;stroke:var(--green);stroke-width:6;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 0.4s ease;}
    .counter-number{font-family:var(--display);font-size:64px;font-weight:800;letter-spacing:-4px;color:var(--ink);line-height:1;margin-bottom:2px;}
    .counter-pct{font-size:14px;font-weight:600;color:var(--ink-muted);margin-bottom:16px;}
    .counter-step-label{font-size:12px;font-weight:600;color:var(--green-dark);min-height:18px;padding:0 8px;}

    /* Step list during scan */
    .step-list{display:flex;flex-direction:column;gap:9px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
    .step-row{display:flex;align-items:flex-start;gap:9px;}
    .step-ind{width:20px;height:20px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;margin-top:1px;border:1.5px solid var(--border-med);color:var(--ink-muted);transition:all 0.3s;}
    .step-ind.done{background:var(--green);border-color:var(--green);color:#fff;}
    .step-ind.active{background:var(--green-pale);border-color:var(--green);color:var(--green-dark);animation:step-pulse 1.6s ease infinite;}
    @keyframes step-pulse{0%,100%{box-shadow:0 0 0 0 rgba(44,182,125,0.3)}50%{box-shadow:0 0 0 4px rgba(44,182,125,0)}}
    .step-txt{font-size:12px;color:var(--ink-muted);line-height:1.45;padding-top:2px;transition:color 0.3s;}
    .step-txt.done{color:var(--ink-sec);}
    .step-txt.active{color:var(--ink);font-weight:600;}
    .check-svg{width:10px;height:10px;stroke:#fff;stroke-width:2.5;fill:none;}

    /* ── REPORT PANEL ── */
    .report-panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);min-height:72vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow-md);}

    /* Panel header */
    .panel-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:16px;flex-shrink:0;}
    .panel-header-left{}
    .panel-header-label{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--ink-muted);margin-bottom:4px;}
    .panel-title{font-family:var(--display);font-size:19px;font-weight:700;color:var(--ink);letter-spacing:-0.3px;}
    .panel-score{font-family:var(--display);font-size:32px;font-weight:800;letter-spacing:-1px;color:var(--ink-muted);}
    .panel-score.green{color:var(--green-dark);}

    /* Error bar */
    .error-bar{display:none;align-items:flex-start;gap:9px;margin:14px 24px 0;padding:10px 14px;background:var(--red-pale);border:1px solid rgba(220,38,38,0.2);border-radius:9px;font-size:13px;color:var(--red);}

    /* Empty state */
    .state-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:72px 32px;}
    .empty-icon{width:60px;height:60px;background:var(--cream);border:1px solid var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;}
    .empty-icon svg{width:26px;height:26px;stroke:var(--ink-muted);fill:none;stroke-width:1.5;}
    .empty-label{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--ink-muted);margin-bottom:10px;}
    .empty-text{font-size:15px;color:var(--ink-sec);line-height:1.75;max-width:360px;margin-bottom:28px;}
    .btn-empty{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:var(--ink);color:#fff;border:none;border-radius:100px;font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .btn-empty:hover{background:#2d2926;transform:translateY(-1px);}

    /* Skeleton while generating */
    .state-skeleton{display:none;flex:1;flex-direction:column;padding:24px;}
    .skel-tags{margin-bottom:20px;display:flex;gap:6px;}
    .skel-tag{display:inline-block;padding:4px 11px;border-radius:6px;font-size:11px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;}
    .skel-tag.green{background:var(--green-pale);color:var(--green-dark);border:1px solid var(--green-border);}
    .skel-tag.muted{background:var(--cream);color:var(--ink-muted);border:1px solid var(--border);}
    .skel-section{border-top:1px solid var(--border);padding:18px 0;transition:opacity 0.6s ease;}
    .skel-section:first-of-type{border-top:none;}
    .skel-num{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--ink-muted);margin-bottom:14px;}
    .skel-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px 24px;}
    .skel-lbl{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--ink-muted);margin-bottom:6px;}
    .skel-val{font-size:14px;font-weight:600;color:var(--ink);}
    .skel-bar{height:12px;background:rgba(0,0,0,0.07);border-radius:4px;animation:shimmer 1.6s ease infinite;}
    .skel-bar.s{width:40%;} .skel-bar.m{width:68%;} .skel-bar.l{width:100%;}
    .skel-bar+.skel-bar{margin-top:8px;}
    @keyframes shimmer{0%,100%{opacity:0.5}50%{opacity:1}}

    /* Report iframe */
    .state-report{display:none;flex:1;flex-direction:column;}
    .report-toolbar{display:flex;align-items:center;gap:10px;padding:12px 20px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
    .btn-toolbar{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border:1px solid var(--border-med);border-radius:8px;font-size:12px;font-weight:600;color:var(--ink-sec);background:var(--cream);cursor:pointer;text-decoration:none;transition:all 0.15s;font-family:var(--font);}
    .btn-toolbar:hover{border-color:var(--green);color:var(--green-dark);background:var(--green-pale);}
    .btn-toolbar.primary{background:var(--ink);color:#fff;border-color:var(--ink);}
    .btn-toolbar.primary:hover{background:#2d2926;color:#fff;}
    .btn-toolbar svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;}
    #report-id-tag{font-size:11px;color:var(--ink-muted);margin-left:auto;}
    .report-frame{border:none;width:100%;flex:1;min-height:65vh;}

    /* ── FOOTER ── */
    footer{padding:20px 32px;border-top:1px solid var(--border);}
    .footer-inner{max-width:1160px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;font-size:12px;color:var(--ink-muted);}
    .footer-links{display:flex;gap:20px;}
    .footer-links a{color:var(--ink-muted);text-decoration:none;}
    .footer-links a:hover{color:var(--ink);}

    /* ── PRINT STYLES ── */
    @media print {
      nav, .sidebar, footer, .report-toolbar { display:none !important; }
      body { background:#fff; }
      main { display:block; }
      .layout { display:block; padding:0; }
      .report-panel { border:none; box-shadow:none; min-height:auto; }
      .panel-header { border-bottom:1px solid #e5e7eb; }
      .state-report { display:flex !important; }
      .report-frame { min-height:100vh; height:auto; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="/" class="logo">
      <div class="logo-mark"><svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg></div>
      <span class="logo-name">Listing Lens.</span>
    </a>
    <span class="nav-badge">Buyer's Dashboard</span>
    <div class="nav-right">
      <span class="nav-no-account">
        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        No account needed
      </span>
      <a href="/" class="btn-nav">← Home</a>
    </div>
  </div>
</nav>

<main>
  <div class="layout">

    <!-- ══ SIDEBAR ══ -->
    <aside class="sidebar" id="sidebar">

      <!-- Joe -->
      <div class="joe-card">
        <img class="joe-img" src="https://listinglens.app/images/meetjoe.jpg" alt="Joe" />
        <div class="joe-card-body">
          <div class="joe-name-row">
            <span class="joe-name">Joe</span>
            <span class="joe-role-tag">Your analyst</span>
          </div>
          <p class="joe-quote">"Tell me what they're selling. I'll tell you what it actually means."</p>
        </div>
      </div>

      <!-- Scan card -->
      <div class="scan-card">

        <!-- PROGRESS (shown while scanning) -->
        <div class="progress-block">
          <div class="counter-wrap">
            <svg class="counter-ring-svg" width="100" height="100" viewBox="0 0 100 100">
              <circle class="counter-track" cx="50" cy="50" r="45"/>
              <circle class="counter-fill" id="counter-ring" cx="50" cy="50" r="45"/>
            </svg>
            <div class="counter-number" id="counter-num">0</div>
            <div class="counter-pct">% complete</div>
            <div class="counter-step-label" id="counter-label">Preparing…</div>
          </div>
          <div class="step-list" id="step-list"></div>
        </div>

        <!-- IDLE -->
        <div class="idle-content">
          <div class="card-label">New scan — $3</div>
          <div class="price-row">
            <span class="price-amount">$3</span>
            <span class="price-sub">Full analysis<br>No account needed</span>
          </div>
          <button id="btn-scan" class="btn-scan">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.2"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg>
            Scan a listing
          </button>
          <p class="upload-hint">Screenshot the listing — price, description, specs, photos. Up to 4 images. Joe does the rest.</p>
          <div id="payment-wrap">
            <div class="card-label">Payment</div>
            <div id="card-element"></div>
            <button class="btn-pay" id="pay-btn">Pay $3 &amp; Generate Report</button>
          </div>
        </div>

      </div>

      <!-- Session reports -->
      <div class="session-card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span class="card-label" style="margin-bottom:0">This session</span>
          <span id="case-count" style="font-size:11px;color:var(--ink-muted);font-weight:600;background:var(--cream);border:1px solid var(--border);padding:2px 8px;border-radius:100px;">0</span>
        </div>
        <ul id="case-list" class="case-list"></ul>
        <p id="no-cases" class="no-cases">No reports yet — run your first scan.</p>
      </div>

    </aside>

    <!-- ══ REPORT PANEL ══ -->
    <section class="report-panel" id="report-panel">

      <div class="panel-header">
        <div class="panel-header-left">
          <div class="panel-header-label">Current report</div>
          <div id="panel-title" class="panel-title">No scan selected yet</div>
        </div>
        <div id="panel-score" class="panel-score">--</div>
      </div>

      <div id="error-bar" class="error-bar">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0;margin-top:3px"></span>
        <span id="error-text">Something went wrong.</span>
      </div>

      <!-- Empty -->
      <div id="state-empty" class="state-empty">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg>
        </div>
        <div class="empty-label">Ready when you are</div>
        <p class="empty-text">Upload screenshots of any listing and Joe will decode the language, flag what's missing, and tell you exactly what it's worth — and what to ask.</p>
        <button id="btn-empty" class="btn-empty">Start your first scan →</button>
      </div>

      <!-- Skeleton -->
      <div id="state-skeleton" class="state-skeleton">
        <div class="skel-tags">
          <span class="skel-tag green" id="sk-tag-type">Vehicle</span>
          <span class="skel-tag muted" id="sk-tag-status">Reading…</span>
        </div>
        <div class="skel-section">
          <div class="skel-num">01 — What this listing is</div>
          <div class="skel-grid">
            <div><div class="skel-lbl">Category</div><div class="skel-val" id="sk-cat"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-lbl">Listed by</div><div class="skel-val" id="sk-by"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-lbl">Location</div><div class="skel-val" id="sk-loc"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-lbl">Price</div><div class="skel-val" id="sk-price"><div class="skel-bar s"></div></div></div>
          </div>
        </div>
        <div class="skel-section" id="sk2" style="opacity:0.2"><div class="skel-num">02 — Comparable sales &amp; market position</div><div class="skel-bar l"></div><div class="skel-bar m"></div><div class="skel-bar s"></div></div>
        <div class="skel-section" id="sk3" style="opacity:0.2"><div class="skel-num">03 — True first-year cost</div><div class="skel-bar m"></div><div class="skel-bar l"></div></div>
        <div class="skel-section" id="sk4" style="opacity:0.2"><div class="skel-num">04 — Red flags &amp; omission analysis</div><div class="skel-bar l"></div><div class="skel-bar m"></div><div class="skel-bar s"></div></div>
        <div class="skel-section" id="sk5" style="opacity:0.2"><div class="skel-num">05 — Closer questions</div><div class="skel-bar m"></div><div class="skel-bar l"></div></div>
        <div class="skel-section" id="sk6" style="opacity:0.2"><div class="skel-num">06 — Joe's verdict</div><div class="skel-bar l"></div><div class="skel-bar l"></div><div class="skel-bar m"></div></div>
      </div>

      <!-- Report -->
      <div id="state-report" class="state-report">
        <div class="report-toolbar">
          <button class="btn-toolbar primary" onclick="printReport()">
            <svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print / Save PDF
          </button>
          <a id="btn-new-tab" class="btn-toolbar" target="_blank">
            <svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            Open in new tab
          </a>
          <span id="report-id-tag"></span>
        </div>
        <iframe id="report-frame" class="report-frame" title="Listing Lens Report" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
      </div>

    </section>

  </div>
</main>

<input id="file-input" type="file" accept="image/*" multiple style="display:none" />

<footer>
  <div class="footer-inner">
    <span>© 2026 Listing Lens · The UPD8 Group Pty Ltd</span>
    <div class="footer-links"><a href="/terms.html">Terms</a><a href="/privacy.html">Privacy</a></div>
  </div>
</footer>

<script>
// ── ENDPOINTS ──
const UPLOAD_URL     = '/api/upload-screenshots';
const QUICK_URL      = '/api/quick-scan';
const GENERATE_URL   = '/api/generate-report';
const BACKGROUND_URL = '/.netlify/functions/stream-report-background';
const STATUS_URL     = '/api/report-status';
const CONFIG_URL     = '/api/config';
const PAYMENT_URL    = '/api/create-payment';

// ── STEPS ──
const STEPS = [
  { label: "Reading listing screenshots",               pct: 12 },
  { label: "Identifying type, platform & location",     pct: 24 },
  { label: "Cross-referencing comparable sales",        pct: 40 },
  { label: "Mapping omissions & red flags",             pct: 55 },
  { label: "Calculating true cost of ownership",        pct: 70 },
  { label: "Compiling closer questions",                pct: 83 },
  { label: "Assembling Joe's verdict",                  pct: 94 },
];
// When each step label appears (ms). Counter runs independently.
const STEP_TIMES = [800, 3000, 6000, 10000, 15000, 21000, 27000];
const SKEL_UNLOCK = { 1:"sk2", 2:"sk3", 3:"sk4", 4:"sk5", 5:"sk6" };

// ── STATE ──
let appConfig     = { betaMode: true, stripePk: '' };
let stripe        = null, cardElement = null;
let pendingSessionId = null;
let cases = [], currentCaseId = null, caseCounter = 1;
let reportDone    = false;   // true once backend returns
let reportPayload = null;    // holds job result until counter reaches 100

// Counter state — physics based
let counterVal    = 0;       // current displayed value (float)
let counterTarget = 0;       // what we're animating toward
let counterRafId  = null;
let stepTimers    = [];

const $ = id => document.getElementById(id);
const sidebar       = $('sidebar');
const counterNum    = $('counter-num');
const counterRing   = $('counter-ring');
const counterLabel  = $('counter-label');
const stepListEl    = $('step-list');
const stateEmpty    = $('state-empty');
const stateSkeleton = $('state-skeleton');
const stateReport   = $('state-report');
const reportFrame   = $('report-frame');
const errorBar      = $('error-bar');
const caseListEl    = $('case-list');
const caseCountEl   = $('case-count');
const panelTitle    = $('panel-title');
const panelScore    = $('panel-score');
const noCases       = $('no-cases');

// ── COUNTER ENGINE ──
// Uses exponential decay so it naturally slows near the target.
// It will NEVER reach 100 on its own — only when we call finishCounter().
const CIRCUMFERENCE = 2 * Math.PI * 45; // 283

function setCounterDisplay(val) {
  const v = Math.min(100, Math.max(0, val));
  const display = Math.floor(v);
  counterNum.textContent = display;
  // SVG ring
  const offset = CIRCUMFERENCE - (v / 100) * CIRCUMFERENCE;
  counterRing.style.strokeDashoffset = offset;
}

function counterTick() {
  const gap = counterTarget - counterVal;
  if (gap > 0.05) {
    // Ease: fast when far, slow when close. Min speed = 0.015%/frame.
    const speed = Math.max(gap * 0.04, 0.015);
    counterVal += speed;
    setCounterDisplay(counterVal);
  }
  counterRafId = requestAnimationFrame(counterTick);
}

function startCounter() {
  counterVal = 0; counterTarget = 0; reportDone = false; reportPayload = null;
  setCounterDisplay(0);
  counterRafId = requestAnimationFrame(counterTick);

  // Gradually push target forward on a schedule — but cap at 94
  // so it never autonomously reaches 100.
  const schedule = [
    [600,   8],
    [2000,  20],
    [4500,  35],
    [7500,  50],
    [12000, 63],
    [18000, 75],
    [24000, 85],
    [32000, 91],
    [42000, 94],   // max autonomous value
  ];
  schedule.forEach(([delay, target]) => {
    const t = setTimeout(() => {
      // Only advance if we haven't finished yet
      if (!reportDone) counterTarget = target;
    }, delay);
    stepTimers.push(t);
  });
}

function finishCounter(cb) {
  // Report is ready — push to 100 smoothly
  reportDone = true;
  counterTarget = 100;
  // Wait for animation to visually reach 100 then fire callback
  const check = setInterval(() => {
    if (counterVal >= 99.5) {
      clearInterval(check);
      setCounterDisplay(100);
      setTimeout(cb, 400);
    }
  }, 50);
}

function stopCounter() {
  if (counterRafId) { cancelAnimationFrame(counterRafId); counterRafId = null; }
  stepTimers.forEach(clearTimeout); stepTimers = [];
}

// ── STEPS UI ──
function buildSteps() {
  stepListEl.innerHTML = '';
  STEPS.forEach((s, i) => {
    stepListEl.insertAdjacentHTML('beforeend',
      `<div class="step-row">
        <div class="step-ind" id="si${i}">${i+1}</div>
        <div class="step-txt" id="st${i}">${s.label}</div>
       </div>`);
  });
}

function setStep(i, state) {
  const ind = $(`si${i}`), txt = $(`st${i}`);
  if (!ind) return;
  ind.className = 'step-ind' + (state==='done'?' done':state==='active'?' active':'');
  txt.className = 'step-txt' + (state==='done'?' done':state==='active'?' active':'');
  ind.innerHTML = state==='done'
    ? '<svg class="check-svg" viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg>'
    : String(i+1);
}

function startSteps() {
  buildSteps();
  STEP_TIMES.forEach((t, i) => {
    const timer = setTimeout(() => {
      if (!sidebar.classList.contains('scanning')) return;
      if (i > 0) setStep(i-1, 'done');
      setStep(i, 'active');
      counterLabel.textContent = STEPS[i].label;
      const unlockId = SKEL_UNLOCK[i];
      if (unlockId) { const el=$(unlockId); if(el) el.style.opacity='1'; }
    }, t);
    stepTimers.push(timer);
  });
}

// ── CONFIG ──
async function loadConfig() {
  try {
    const res = await fetch(CONFIG_URL);
    if (res.ok) appConfig = await res.json();
  } catch { appConfig = { betaMode: true }; }
  if (!appConfig.betaMode && appConfig.stripePk && window.Stripe) {
    stripe = window.Stripe(appConfig.stripePk);
    const els = stripe.elements({ appearance: { theme: 'stripe' } });
    cardElement = els.create('card', { style:{ base:{ color:'#1a1714', fontFamily:'DM Sans,sans-serif', fontSize:'14px' } } });
    cardElement.mount('#card-element');
    $('payment-wrap').style.display = 'block';
    $('pay-btn').addEventListener('click', handlePayment);
  }
}

// ── PAYMENT ──
async function handlePayment() {
  if (!stripe || !cardElement || !pendingSessionId) return;
  try {
    $('pay-btn').disabled = true;
    $('pay-btn').textContent = 'Processing…';
    const res = await fetch(PAYMENT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount:300 }) });
    const payment = await res.json();
    const { error, paymentIntent } = await stripe.confirmCardPayment(payment.clientSecret, { payment_method:{ card: cardElement } });
    if (error) throw new Error(error.message);
    $('payment-wrap').style.display = 'none';
    beginScanAnimation();
    await startReportGeneration(pendingSessionId, paymentIntent.id);
  } catch(e) {
    $('pay-btn').disabled = false;
    $('pay-btn').textContent = 'Pay $3 & Generate Report';
    showError('Payment failed: ' + (e.message||'Unknown error'));
  }
}

// ── ERROR ──
function showError(msg) {
  if (!msg) { errorBar.style.display='none'; return; }
  $('error-text').textContent = msg.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim().slice(0,200);
  errorBar.style.display = 'flex';
}

// ── VIEW HELPERS ──
function resetView() {
  stopCounter();
  sidebar.classList.remove('scanning');
  showError('');
  stateEmpty.style.display    = 'flex';
  stateSkeleton.style.display = 'none';
  stateReport.style.display   = 'none';
  reportFrame.srcdoc          = '';
  panelTitle.textContent      = 'No scan selected yet';
  panelScore.textContent      = '--';
  panelScore.className        = 'panel-score';
}

function beginScanAnimation() {
  stateEmpty.style.display    = 'none';
  stateReport.style.display   = 'none';
  stateSkeleton.style.display = 'flex';
  ['sk2','sk3','sk4','sk5','sk6'].forEach(id => { const el=$(id); if(el) el.style.opacity='0.2'; });
  $('sk-tag-type').textContent   = 'Vehicle';
  $('sk-tag-status').textContent = 'Reading…';
  ['sk-cat','sk-by','sk-loc','sk-price'].forEach(id => {
    const el=$(id); if(el) el.innerHTML='<div class="skel-bar s"></div>';
  });
  sidebar.classList.add('scanning');
  startCounter();
  startSteps();
  counterLabel.textContent = 'Preparing…';
}

// ── UPLOAD ──
async function uploadFiles(files) {
  const fd = new FormData();
  Array.from(files).slice(0,4).forEach(f => fd.append('screenshot', f));
  const res = await fetch(UPLOAD_URL, { method:'POST', body:fd });
  if (!res.ok) {
    const t = await res.text().catch(()=>'');
    throw new Error(t.replace(/<[^>]*>/g,'').trim().slice(0,120) || `Upload failed (${res.status})`);
  }
  return res.json();
}

// ── QUICK SCAN ──
async function runQuickScan(sessionId) {
  try {
    const res = await fetch(QUICK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, tier:'standard' }) });
    return res.ok ? res.json() : null;
  } catch { return null; }
}

function applyQuickScan(qs) {
  if (!qs) return;
  if (qs.category) { $('sk-tag-type').textContent=qs.category; $('sk-cat').textContent=qs.category; }
  if (qs.price)       $('sk-price').textContent  = qs.price;
  if (qs.location)    $('sk-loc').textContent    = qs.location;
  if (qs.seller_type) $('sk-by').textContent     = qs.seller_type;
  if (qs.title)       $('sk-tag-status').textContent = qs.title.slice(0,40);
  const sk2 = $('sk2'); if(sk2) sk2.style.opacity='1';
}

// ── GENERATE ──
async function generateReport(sessionId) {
  const res = await fetch(GENERATE_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId }) });
  if (!res.ok) throw new Error('Session validation failed — please try again');
  return res.json();
}

function kickBackground(sessionId, jobId, paymentIntentId) {
  fetch(BACKGROUND_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, jobId, paymentIntentId: paymentIntentId||null }) }).catch(()=>{});
}

// ── POLL ──
function pollStatus(jobId) {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    const iv = setInterval(async () => {
      if (++attempts > 120) { clearInterval(iv); reject(new Error('Report timed out — please try again')); return; }
      try {
        const res = await fetch(`${STATUS_URL}?jobId=${jobId}`);
        const job = await res.json();
        if (job.status === 'complete') { clearInterval(iv); resolve(job); }
        else if (job.status === 'error') { clearInterval(iv); reject(new Error(job.error||'Report generation failed')); }
      } catch {}
    }, 3000);
  });
}

// ── SHOW REPORT ──
function showReport(html, reportId, title) {
  stateSkeleton.style.display = 'none';
  stateEmpty.style.display    = 'none';
  stateReport.style.display   = 'flex';
  reportFrame.srcdoc = html;
  // Open-in-new-tab blob
  const blob = new Blob([html], { type:'text/html' });
  $('btn-new-tab').href = URL.createObjectURL(blob);
  $('report-id-tag').textContent = reportId || '';
  panelTitle.textContent = title || 'Report ready';
  panelScore.textContent = '✓';
  panelScore.className   = 'panel-score green';
}

// ── PRINT ──
function printReport() {
  // Try printing the iframe contents directly
  try {
    reportFrame.contentWindow.focus();
    reportFrame.contentWindow.print();
  } catch {
    window.print();
  }
}

// ── CASES ──
function renderCases() {
  caseListEl.innerHTML = '';
  noCases.style.display = cases.length ? 'none' : 'block';
  cases.forEach(c => {
    const li = document.createElement('li');
    li.className = 'case-item' + (c.id===currentCaseId?' active':'');
    li.innerHTML = `<div class="case-title">${c.title}</div><div class="case-meta">${c.shortTime}</div>`;
    li.addEventListener('click', () => { currentCaseId=c.id; renderCases(); showReport(c.html, c.reportId, c.title); });
    caseListEl.appendChild(li);
  });
  caseCountEl.textContent = cases.length;
}

// ── MAIN REPORT FLOW ──
async function startReportGeneration(sessionId, paymentIntentId) {
  try {
    const { jobId } = await generateReport(sessionId);
    kickBackground(sessionId, jobId, paymentIntentId);
    runQuickScan(sessionId).then(qs => applyQuickScan(qs));
    const job = await pollStatus(jobId);
    // Mark all steps done
    STEPS.forEach((_,i) => setStep(i,'done'));
    counterLabel.textContent = 'Report ready — loading…';
    // Let counter reach 100 then reveal
    finishCounter(() => {
      stopCounter();
      sidebar.classList.remove('scanning');
      const now = new Date();
      const nc = {
        id: `case-${caseCounter++}`,
        title: job.reportId || 'Report',
        reportId: job.reportId,
        html: job.html,
        shortTime: now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
      };
      cases.unshift(nc);
      currentCaseId = nc.id;
      renderCases();
      showReport(job.html, job.reportId, job.reportId || 'Report ready');
    });
  } catch(err) {
    stopCounter();
    sidebar.classList.remove('scanning');
    showError(err?.message || 'Analysis failed — please try again.');
    stateEmpty.style.display    = 'flex';
    stateSkeleton.style.display = 'none';
  }
}

// ── HANDLE SCAN (upload then branch) ──
async function handleScan(files) {
  if (!files || !files.length) return;
  showError('');
  beginScanAnimation();
  $('btn-scan').disabled = true;
  try {
    const { sessionId } = await uploadFiles(files);
    pendingSessionId = sessionId;
    if (appConfig.betaMode) {
      await startReportGeneration(sessionId, null);
    } else {
      // Pause counter at ~12, show payment form
      counterTarget = 12;
      stopCounter(); // stop advancing, user needs to pay
      sidebar.classList.remove('scanning');
      $('payment-wrap').style.display = 'block';
      $('pay-btn').disabled = false;
      $('pay-btn').textContent = 'Pay $3 & Generate Report';
      panelTitle.textContent = 'Complete payment to generate report';
    }
  } catch(err) {
    stopCounter();
    sidebar.classList.remove('scanning');
    showError(err?.message || 'Upload failed — please try again.');
    stateEmpty.style.display    = 'flex';
    stateSkeleton.style.display = 'none';
  } finally {
    $('btn-scan').disabled = false;
  }
}

// ── INIT ──
document.addEventListener('DOMContentLoaded', async () => {
  resetView();
  await loadConfig();
  const triggerScan = () => { showError(''); $('file-input').value=''; $('file-input').click(); };
  $('btn-scan').addEventListener('click', triggerScan);
  $('btn-empty').addEventListener('click', triggerScan);
  $('file-input').addEventListener('change', e => { if (e.target.files?.length) handleScan(e.target.files); });
});
</script>
</body>
</html>
