<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Lens â€” New Scan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Serif+Display&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --bg: #FAFAF9; --bg-white: #FFFFFF; --text: #1A1A1A; --text-sec: #555; --text-muted: #888;
            --border: #E5E5E3; --border-light: #F0F0EE;
            --accent: #16803C; --accent-hover: #14662F; --accent-bg: #F0FDF4;
            --red: #DC2626; --red-bg: #FEF2F2;
            --radius: 10px;
            --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'DM Serif Display', Georgia, serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; }

        nav { background: rgba(250,250,249,0.92); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); padding: 0 24px; position: sticky; top: 0; z-index: 50; }
        .nav-inner { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text); }
        .logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 18px; height: 18px; }
        .logo-text { font-weight: 700; font-size: 16px; }
        .nav-link { font-size: 14px; color: var(--text-muted); text-decoration: none; }

        .container { max-width: 600px; margin: 0 auto; padding: 40px 24px 80px; }
        .page-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 6px; }
        .page-sub { font-size: 15px; color: var(--text-sec); margin-bottom: 36px; }

        /* UPLOAD */
        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 56px 24px; text-align: center; background: var(--bg-white); cursor: pointer; transition: all 0.15s; position: relative; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-bg); }
        .upload-zone svg { width: 40px; height: 40px; color: var(--text-muted); margin-bottom: 16px; }
        .upload-zone h3 { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        .upload-zone p { font-size: 14px; color: var(--text-muted); }
        .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .upload-hint { margin-top: 16px; font-size: 13px; color: var(--text-muted); display: flex; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap; }
        .upload-hint span { display: flex; align-items: center; gap: 5px; }

        .file-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; }
        .file-thumb { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 12px; color: var(--text-muted); }
        .file-remove { width: 28px; height: 28px; border: none; background: var(--red-bg); color: var(--red); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }

        /* PAYMENT */
        .payment-section { display: none; margin-top: 24px; }
        .payment-section.active { display: block; }
        .payment-box { background: var(--bg-white); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
        .payment-loading { display: flex; align-items: center; gap: 12px; padding: 20px 0; color: var(--text-muted); font-size: 14px; }
        .payment-loading-spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
        #payment-element { margin-bottom: 20px; }
        .pay-btn { width: 100%; padding: 16px; font-family: var(--font); font-size: 16px; font-weight: 700; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); cursor: pointer; transition: all 0.15s; }
        .pay-btn:hover:not(:disabled) { background: var(--accent-hover); }
        .pay-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .payment-error { color: var(--red); font-size: 14px; margin-top: 12px; display: none; }
        .payment-secure { text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; }

        .price-picker { margin-bottom: 20px; }
        .price-picker-label { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; }
        .price-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .price-opt { position: relative; cursor: pointer; }
        .price-opt input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
        .price-opt-inner { display: flex; flex-direction: column; align-items: center; padding: 14px 10px 12px; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); transition: all 0.15s; text-align: center; }
        .price-opt:hover .price-opt-inner { border-color: var(--accent); }
        .price-opt input:checked + .price-opt-inner { border-color: var(--accent); background: var(--accent-bg); }
        .price-opt-amount { font-size: 22px; font-weight: 800; color: var(--text); line-height: 1; margin-bottom: 4px; }
        .price-opt input:checked + .price-opt-inner .price-opt-amount { color: var(--accent); }
        .price-opt-tag { font-size: 11px; font-weight: 600; color: var(--text-muted); }
        .price-opt-badge { display: inline-block; font-size: 10px; font-weight: 700; background: var(--accent); color: #fff; border-radius: 4px; padding: 2px 6px; margin-bottom: 4px; }

        .beta-banner { background: var(--accent-bg); border: 1px solid rgba(22,128,60,0.2); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 16px; text-align: center; }
        .beta-banner p { font-size: 14px; color: #166534; font-weight: 500; margin: 0; }
        .submit-btn { width: 100%; padding: 16px; font-family: var(--font); font-size: 16px; font-weight: 700; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); cursor: pointer; transition: all 0.15s; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .privacy-strip { margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); }
        .privacy-strip span { display: flex; align-items: center; gap: 5px; }

        /* =====================================================
           SPLIT-SCREEN GENERATION VIEW
           Left: ticker / Right: report builds live
           ===================================================== */

        /* Full-screen split container */
        .gen-overlay {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: #0A0A0A;
            flex-direction: row;
        }
        .gen-overlay.active { display: flex; }

        /* LEFT PANEL â€” ticker */
        .gen-left {
            width: 380px;
            min-width: 340px;
            flex-shrink: 0;
            background: #0A0A0A;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 48px 40px;
            border-right: 1px solid rgba(255,255,255,0.08);
            position: relative;
            z-index: 10;
        }

        /* RIGHT PANEL â€” live report builds here */
        .gen-right {
            flex: 1;
            overflow-y: auto;
            background: #ffffff;
            position: relative;
        }
        /* Empty state â€” centred icon shown before first HTML arrives */
        .gen-right-empty {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .gen-right-empty.hidden { opacity: 0; }
        .gen-right-empty svg { width: 48px; height: 48px; }
        .gen-right-empty p { font-size: 13px; color: rgba(100,116,139,0.5); font-family: var(--font-mono); letter-spacing: 0.05em; }

        /* Live iframe â€” report streams in here */
        #liveFrame {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background: #ffffff;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #liveFrame.visible { opacity: 1; }

        /* Foreground content (inside left panel) */
        .gen-foreground { width: 100%; }

        /* LL logo mark */
        .gen-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 48px; }
        .gen-logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .gen-logo-icon svg { width: 18px; height: 18px; }
        .gen-logo-text { font-weight: 700; font-size: 16px; color: #fff; }

        /* Status line */
        .gen-status { font-family: var(--font-mono); font-size: 12px; color: #4ade80; margin-bottom: 20px; min-height: 18px; }
        .gen-status-dot { display: inline-block; width: 6px; height: 6px; background: #4ade80; border-radius: 50%; margin-right: 8px; animation: pulse-dot 1.2s ease infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Progress bar */
        .gen-bar-wrap { width: 100%; height: 2px; background: rgba(255,255,255,0.1); border-radius: 1px; margin-bottom: 14px; overflow: hidden; }
        .gen-bar { height: 100%; background: #4ade80; border-radius: 1px; width: 0%; transition: width 0.4s ease; }

        /* Percentage */
        .gen-pct { font-family: var(--font-mono); font-size: 56px; font-weight: 700; color: #fff; line-height: 1; margin-bottom: 6px; letter-spacing: -2px; }
        .gen-pct-label { font-size: 13px; color: rgba(255,255,255,0.4); margin-bottom: 36px; }

        /* Steps */
        .gen-steps { display: flex; flex-direction: column; gap: 9px; }
        .gen-step { display: flex; align-items: center; gap: 11px; font-size: 13px; color: rgba(255,255,255,0.3); transition: color 0.4s; }
        .gen-step.active { color: rgba(255,255,255,0.9); }
        .gen-step.done { color: rgba(255,255,255,0.45); }
        .gen-step-icon { width: 20px; height: 20px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; transition: all 0.4s; font-family: var(--font-mono); }
        .gen-step.active .gen-step-icon { border-color: #4ade80; color: #4ade80; animation: pulse-border 1.4s ease infinite; }
        .gen-step.done .gen-step-icon { border-color: #4ade80; background: #4ade80; color: #0A0A0A; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 0 0 rgba(74,222,128,0.3); } 50% { box-shadow: 0 0 0 4px rgba(74,222,128,0); } }

        /* Fade out left panel when done */
        .gen-overlay.completing .gen-left { animation: fadeOutLeft 0.6s ease forwards; }
        @keyframes fadeOutLeft { to { opacity: 0; transform: translateX(-16px); } }

        /* Mobile: stack vertically */
        @media (max-width: 640px) {
            .gen-overlay { flex-direction: column; }
            .gen-overlay { flex-direction: column; }
            .gen-left { width: 100%; min-width: unset; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); padding: 28px 24px; flex-shrink: 0; max-height: 50vh; overflow-y: auto; }
            .gen-right { flex: 1; min-height: 200px; }
            .gen-steps { display: none; }
            .gen-pct { font-size: 40px; }
            .gen-logo { margin-bottom: 24px; }
            .gen-pct-label { margin-bottom: 20px; }
        }

        /* Unused blur layer kept for compat */
        .gen-report-blur { display: none; }

        /* REPORT (final view after gen completes) */
        .report-container { display: none; background: #f8fafc; min-height: 100vh; }
        .report-container.active { display: block; }
        .report-iframe-wrap { background: #f8fafc; }
        #reportFrame { width: 100%; border: none; min-height: 600px; display: block; background: #f8fafc; }
        .report-actions { display: flex; justify-content: center; gap: 12px; padding: 20px 0 48px; flex-wrap: wrap; }
        .action-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--bg-white); border: 2px solid var(--border); border-radius: var(--radius); font-family: var(--font); font-size: 14px; font-weight: 600; color: var(--text); cursor: pointer; transition: all 0.15s; text-decoration: none; }
        .action-btn:hover { border-color: var(--accent); color: var(--accent); }
        .action-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
        .action-btn.primary:hover { background: var(--accent-hover); }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<nav>
    <div class="nav-inner">
        <a href="/" class="logo">
            <div class="logo-icon"><svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg></div>
            <span class="logo-text">Listing Lens</span>
        </a>
        <a href="/" class="nav-link">â† Back to home</a>
    </div>
</nav>

<!-- FORM -->
<div class="container" id="formContainer">
    <h1 class="page-title">New Scan</h1>
    <p class="page-sub">Upload screenshots of any listing. We'll handle the rest.</p>

    <div class="upload-zone" id="uploadZone">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5-5 5 5m-5-5v12" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>Drop your listing screenshots here</h3>
        <p>Car, property, electronics â€” anything. We'll figure it out.</p>
        <div class="upload-hint">
            <span>ğŸ“ PNG, JPG, WEBP</span>
            <span>ğŸ“ Up to 10MB each</span>
            <span>ğŸ–¼ï¸ Up to 6 images</span>
        </div>
        <input type="file" id="fileInput" accept="image/*" multiple>
    </div>
    <div class="file-list" id="fileList"></div>

    <!-- PAYMENT (live) -->
    <div class="payment-section" id="paymentSection">
        <div class="payment-box">
            <div class="price-picker" id="pricePicker">
                <div class="price-picker-label">Choose what feels right</div>
                <div class="price-options">
                    <label class="price-opt">
                        <input type="radio" name="price" value="200" checked onchange="onPriceChange(this)">
                        <div class="price-opt-inner"><span class="price-opt-amount">$2</span><span class="price-opt-tag">Covers costs</span></div>
                    </label>
                    <label class="price-opt">
                        <input type="radio" name="price" value="500" onchange="onPriceChange(this)">
                        <div class="price-opt-inner"><span class="price-opt-amount">$5</span><span class="price-opt-tag">Good value</span></div>
                    </label>
                    <label class="price-opt">
                        <input type="radio" name="price" value="1000" onchange="onPriceChange(this)">
                        <div class="price-opt-inner">
                            <div class="price-opt-badge">ğŸ™Œ Generous</div>
                            <span class="price-opt-amount">$10</span><span class="price-opt-tag">Helps others</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="payment-loading" id="paymentLoading">
                <div class="payment-loading-spinner"></div>
                <span id="paymentLoadingText">Securing your screenshots...</span>
            </div>
            <div id="payment-element" style="display:none;"></div>
            <button class="pay-btn" id="payBtn" onclick="handlePayment()" disabled style="display:none;">Pay $2 &amp; Generate Report</button>
            <div class="payment-error" id="paymentError"></div>
            <div class="payment-secure" id="paymentSecure" style="display:none;">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Secure payment via Stripe Â· Your card details never touch our servers
            </div>
        </div>
    </div>

    <!-- BETA -->
    <div id="betaSection" style="display:none;">
        <div class="beta-banner"><p>ğŸ§ª Beta mode â€” payment skipped</p></div>
        <button class="submit-btn" id="betaBtn" disabled onclick="handleBetaSubmit()">Generate Report (Beta)</button>
    </div>

    <div class="privacy-strip">
        <span>ğŸ”’ No account required</span>
        <span>ğŸ—‘ï¸ Screenshots deleted in 15 min</span>
        <span>ğŸŒ Works worldwide</span>
    </div>
</div>

<!-- GENERATION OVERLAY â€” GROK STYLE -->
<div class="gen-overlay" id="genOverlay">

    <!-- LEFT: Ticker panel -->
    <div class="gen-left">
        <div class="gen-logo">
            <div class="gen-logo-icon"><svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg></div>
            <span class="gen-logo-text">Listing Lens</span>
        </div>

        <div class="gen-status" id="genStatus">
            <span class="gen-status-dot"></span><span id="genStatusText">Reading screenshots...</span>
        </div>

        <div class="gen-bar-wrap"><div class="gen-bar" id="genBar"></div></div>

        <div class="gen-pct" id="genPct">0%</div>
        <div class="gen-pct-label">Analysing your listing</div>

        <div class="gen-steps">
            <div class="gen-step" id="gs1"><div class="gen-step-icon">1</div> Reading your screenshots</div>
            <div class="gen-step" id="gs2"><div class="gen-step-icon">2</div> Identifying listing type &amp; location</div>
            <div class="gen-step" id="gs3"><div class="gen-step-icon">3</div> Checking market data &amp; comparables</div>
            <div class="gen-step" id="gs4"><div class="gen-step-icon">4</div> Flagging what they didn't tell you</div>
            <div class="gen-step" id="gs5"><div class="gen-step-icon">5</div> Calculating true cost of ownership</div>
            <div class="gen-step" id="gs6"><div class="gen-step-icon">6</div> Building your negotiation strategy</div>
            <div class="gen-step" id="gs7"><div class="gen-step-icon">7</div> Generating report</div>
        </div>
    </div>

    <!-- RIGHT: Live report panel -->
    <div class="gen-right" id="genRight">
        <!-- Empty state while waiting for first chunks -->
        <div class="gen-right-empty" id="genRightEmpty">
            <svg fill="none" viewBox="0 0 48 48" stroke="rgba(100,116,139,0.4)" stroke-width="1.5">
                <circle cx="21" cy="21" r="13"/>
                <path d="m32 32 8 8" stroke-linecap="round"/>
            </svg>
            <span>Report building...</span>
        </div>
        <!-- Live iframe â€” report streams in here -->
        <iframe id="liveFrame" sandbox="allow-same-origin" scrolling="yes"></iframe>
    </div>

</div>

<!-- REPORT -->
<div class="container report-container" id="reportContainer">
    <div class="report-iframe-wrap">
        <iframe id="reportFrame" sandbox="allow-same-origin" scrolling="no"></iframe>
    </div>
    <div class="report-actions">
        <button class="action-btn primary" onclick="downloadReport()">â†“ Download Report</button>
        <button class="action-btn" onclick="resetForm()">â† New Scan</button>
    </div>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var uploadedFiles      = [];
var sessionId          = null;
var stripe             = null;
var elements           = null;
var paymentElement     = null;
var clientSecret       = null;
var paymentIntentId    = null;
var betaMode           = false;
var currentReportHtml  = '';
var currentReportId    = '';
var stripeInitialised  = false;
var stripeInitialising = false;
var uploadInProgress   = false;
var selectedPrice      = 200;

// Ticker state
var tickerInterval     = null;
var tickerPct          = 0;
var tickerTarget       = 0;
var tickerDone         = false;

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
    try {
        var res = await fetch('/api/config');
        if (res.ok) {
            var cfg = await res.json();
            betaMode = cfg.betaMode || false;
            window.STRIPE_PK = cfg.stripePk || '';
        }
    } catch (e) { console.warn('Config fetch failed'); }
}
boot();

// â”€â”€â”€ PRICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onPriceChange(input) {
    var newPrice = parseInt(input.value, 10);
    if (newPrice === selectedPrice) return;
    selectedPrice = newPrice;
    var labels = { 200: '$2', 500: '$5', 1000: '$10' };
    var payBtn = document.getElementById('payBtn');
    if (payBtn) payBtn.textContent = 'Pay ' + (labels[selectedPrice] || '$2') + ' & Generate Report';
    if (stripeInitialised || stripeInitialising) {
        stripe = null; elements = null; paymentElement = null;
        clientSecret = null; paymentIntentId = null;
        stripeInitialised = false; stripeInitialising = false;
        document.getElementById('payment-element').innerHTML = '';
        document.getElementById('payment-element').style.display = 'none';
        document.getElementById('payBtn').style.display = 'none';
        document.getElementById('paymentSecure').style.display = 'none';
        showPaymentLoading('Updating payment...');
        if (sessionId) initStripe();
    }
}

// â”€â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var uploadZone = document.getElementById('uploadZone');
var fileInput  = document.getElementById('fileInput');
var fileList   = document.getElementById('fileList');

uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
uploadZone.addEventListener('drop', function(e) {
    e.preventDefault(); uploadZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', function(e) { handleFiles(e.target.files); fileInput.value = ''; });

function handleFiles(newFiles) {
    for (var i = 0; i < newFiles.length; i++) {
        if (uploadedFiles.length >= 6) break;
        var f = newFiles[i];
        if (!f.type.startsWith('image/') || f.size > 10485760) continue;
        uploadedFiles.push(f);
    }
    sessionId = null; stripeInitialised = false; stripeInitialising = false;
    renderFiles(); checkReady();
}

function renderFiles() {
    fileList.innerHTML = uploadedFiles.map(function(f, i) {
        return '<div class="file-item">' +
            '<img src="' + URL.createObjectURL(f) + '" class="file-thumb" alt="">' +
            '<div class="file-info"><div class="file-name">' + esc(f.name) + '</div>' +
            '<div class="file-size">' + (f.size / 1024).toFixed(0) + ' KB</div></div>' +
            '<button class="file-remove" onclick="removeFile(' + i + ')">Ã—</button>' +
            '</div>';
    }).join('');
    uploadZone.style.display = uploadedFiles.length >= 6 ? 'none' : '';
}

function removeFile(i) {
    uploadedFiles.splice(i, 1);
    sessionId = null; stripeInitialised = false; stripeInitialising = false;
    renderFiles(); checkReady();
}

// â”€â”€â”€ READY CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkReady() {
    var ready = uploadedFiles.length > 0;

    if (betaMode) {
        document.getElementById('betaSection').style.display = ready ? '' : 'none';
        document.getElementById('paymentSection').classList.remove('active');
        document.getElementById('betaBtn').disabled = !ready;
        if (ready && !sessionId && !uploadInProgress) await uploadScreenshots();
        return;
    }

    if (ready) {
        document.getElementById('paymentSection').classList.add('active');
        if (!sessionId && !uploadInProgress) await uploadScreenshots();
        if (sessionId && !stripeInitialised && !stripeInitialising) await initStripe();
    } else {
        document.getElementById('paymentSection').classList.remove('active');
    }
}

// â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadScreenshots() {
    uploadInProgress = true;
    showPaymentLoading('Securing your screenshots...');
    try {
        var fd = new FormData();
        uploadedFiles.forEach(function(f, i) { fd.append('screenshot_' + i, f); });
        var res  = await fetch('/api/upload-screenshots', { method: 'POST', body: fd });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Upload failed');
        sessionId = data.sessionId;
        showPaymentLoading('Setting up secure payment...');
    } catch (err) {
        console.error('Upload error:', err);
        hidePaymentLoading();
        showPaymentError('Could not secure your screenshots. Please try again.');
    } finally {
        uploadInProgress = false;
    }
}

// â”€â”€â”€ STRIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initStripe() {
    stripeInitialising = true;
    try {
        var res  = await fetch('/api/create-payment', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: selectedPrice })
        });
        var data = await res.json();
        if (!data.clientSecret) throw new Error('No client secret');
        clientSecret = data.clientSecret;
        paymentIntentId = data.paymentIntentId;
        if (!window.STRIPE_PK) throw new Error('Stripe key not configured');
        stripe = Stripe(window.STRIPE_PK);
        elements = stripe.elements({
            clientSecret,
            appearance: {
                theme: 'stripe',
                variables: { colorPrimary: '#16803C', colorBackground: '#FFFFFF', colorText: '#1A1A1A', colorDanger: '#DC2626', fontFamily: 'DM Sans, system-ui, sans-serif', spacingUnit: '4px', borderRadius: '8px' }
            }
        });
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        paymentElement.on('ready', function() {
            hidePaymentLoading();
            document.getElementById('payment-element').style.display = '';
            document.getElementById('payBtn').style.display = '';
            document.getElementById('paymentSecure').style.display = '';
            var labels = { 200: '$2', 500: '$5', 1000: '$10' };
            document.getElementById('payBtn').textContent = 'Pay ' + (labels[selectedPrice] || '$2') + ' & Generate Report';
            stripeInitialised = true; stripeInitialising = false;
        });
        paymentElement.on('change', function(event) {
            document.getElementById('payBtn').disabled = !event.complete;
            if (event.error) showPaymentError(event.error.message);
            else hidePaymentError();
        });
    } catch (err) {
        console.error('Stripe init error:', err);
        hidePaymentLoading();
        showPaymentError('Payment system unavailable. Please refresh and try again.');
        stripeInitialising = false;
    }
}

function showPaymentLoading(msg) {
    document.getElementById('paymentLoadingText').textContent = msg || 'Loading...';
    document.getElementById('paymentLoading').style.display = 'flex';
    document.getElementById('payment-element').style.display = 'none';
    document.getElementById('payBtn').style.display = 'none';
    document.getElementById('paymentSecure').style.display = 'none';
}
function hidePaymentLoading() { document.getElementById('paymentLoading').style.display = 'none'; }
function showPaymentError(msg) { var el = document.getElementById('paymentError'); el.textContent = msg; el.style.display = ''; }
function hidePaymentError() { document.getElementById('paymentError').style.display = 'none'; }

// â”€â”€â”€ PAYMENT HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handlePayment() {
    var payBtn = document.getElementById('payBtn');
    payBtn.disabled = true; payBtn.textContent = 'Processing...';
    var result = await stripe.confirmPayment({
        elements,
        confirmParams: { return_url: window.location.href },
        redirect: 'if_required'
    });
    if (result.error) {
        showPaymentError(result.error.message);
        payBtn.disabled = false;
        var labels = { 200: '$2', 500: '$5', 1000: '$10' };
        payBtn.textContent = 'Pay ' + (labels[selectedPrice] || '$2') + ' & Generate Report';
        return;
    }
    generateReport(paymentIntentId);
}

function handleBetaSubmit() { generateReport(null); }

// â”€â”€â”€ GROK TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Eased progress curve: fast start, slows near end, holds just below 99%
// until the report actually arrives, then snaps to 100%.
var STEPS = [
    { id: 'gs1', label: 'Reading your screenshots',           pct: 10, ms: 0    },
    { id: 'gs2', label: 'Identifying listing type & location',pct: 22, ms: 3000 },
    { id: 'gs3', label: 'Checking market data & comparables', pct: 38, ms: 7000 },
    { id: 'gs4', label: 'Flagging what they didn\'t tell you',pct: 54, ms: 13000},
    { id: 'gs5', label: 'Calculating true cost of ownership', pct: 68, ms: 20000},
    { id: 'gs6', label: 'Building your negotiation strategy', pct: 80, ms: 28000},
    { id: 'gs7', label: 'Generating report',                  pct: 88, ms: 36000},
];

var stepTimers = [];
var pctInterval = null;
var creepInterval = null;
var currentPct = 0;
var targetPct  = 0;

function startTicker() {
    currentPct = 0; targetPct = 0;
    document.getElementById('genPct').textContent = '0%';
    document.getElementById('genBar').style.width = '0%';
    document.getElementById('genStatusText').textContent = 'Reading screenshots...';

    // Reset steps
    STEPS.forEach(function(s) {
        var el = document.getElementById(s.id);
        el.classList.remove('active', 'done');
        el.querySelector('.gen-step-icon').textContent = s.id.replace('gs','');
    });

    // First step active immediately
    document.getElementById('gs1').classList.add('active');

    // Schedule step advances
    STEPS.forEach(function(step, i) {
        var t = setTimeout(function() {
            // Mark previous done
            if (i > 0) {
                var prev = document.getElementById(STEPS[i-1].id);
                prev.classList.remove('active'); prev.classList.add('done');
                prev.querySelector('.gen-step-icon').textContent = 'âœ“';
            }
            // Mark this active
            var el = document.getElementById(step.id);
            el.classList.add('active');
            document.getElementById('genStatusText').textContent = step.label;
            targetPct = step.pct;
            // Last step: start slow creep so ticker never freezes while waiting
            if (i === STEPS.length - 1) {
                setTimeout(function() { startCreep(); }, 2000);
            }
        }, step.ms);
        stepTimers.push(t);
    });

    // Smooth percentage counter â€” runs every 80ms
    pctInterval = setInterval(function() {
        if (currentPct < targetPct) {
            // Ease: faster when far, slower near target
            var diff = targetPct - currentPct;
            var step = Math.max(0.3, diff * 0.06);
            currentPct = Math.min(targetPct, currentPct + step);
            var display = Math.floor(currentPct);
            document.getElementById('genPct').textContent = display + '%';
            document.getElementById('genBar').style.width = display + '%';
        }
    }, 80);
}

function stopTicker() {
    stepTimers.forEach(function(t) { clearTimeout(t); });
    stepTimers = [];
    if (pctInterval) { clearInterval(pctInterval); pctInterval = null; }
    if (creepInterval) { clearInterval(creepInterval); creepInterval = null; }
}

// Slowly creep 88% â†’ 98% while waiting for API after all steps done
// Keeps ticker moving so it never appears frozen
function startCreep() {
    if (creepInterval) return;
    creepInterval = setInterval(function() {
        if (currentPct < 98) {
            currentPct = Math.min(98, currentPct + 0.04);
            var d = Math.floor(currentPct);
            document.getElementById('genPct').textContent = d + '%';
            document.getElementById('genBar').style.width = d + '%';
        } else {
            clearInterval(creepInterval); creepInterval = null;
        }
    }, 80);
}

function completeTicker() {
    return new Promise(function(resolve) {
        stopTicker();

        // Mark all steps done
        STEPS.forEach(function(s) {
            var el = document.getElementById(s.id);
            el.classList.remove('active'); el.classList.add('done');
            el.querySelector('.gen-step-icon').textContent = 'âœ“';
        });

        // Animate to 100%
        targetPct = 100;
        document.getElementById('genStatusText').textContent = 'Report ready';
        var snap = setInterval(function() {
            currentPct = Math.min(100, currentPct + 2);
            document.getElementById('genPct').textContent = Math.floor(currentPct) + '%';
            document.getElementById('genBar').style.width = Math.floor(currentPct) + '%';
            if (currentPct >= 100) {
                clearInterval(snap);
                setTimeout(resolve, 400);
            }
        }, 30);
    });
}

// â”€â”€â”€ GENERATE REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateReport(paymentId) {
    document.getElementById('formContainer').style.display = 'none';
    document.getElementById('genOverlay').classList.add('active');
    startTicker();

    try {
        var sid = sessionId;

        if (!sid) {
            var fd = new FormData();
            uploadedFiles.forEach(function(f, i) { fd.append('screenshot_' + i, f); });
            var upRes  = await fetch('/api/upload-screenshots', { method: 'POST', body: fd });
            var upData = await upRes.json();
            if (!upRes.ok) throw new Error(upData.error || 'Upload failed');
            sid = upData.sessionId;
        }

        // Call streaming endpoint â€” waits for Claude to finish, returns all chunks
        var streamRes = await fetch('/.netlify/functions/stream-report-background', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: sid, paymentIntentId: paymentId })
        });

        if (streamRes.status === 410) {
            var errData = await streamRes.json().catch(function() { return {}; });
            throw new Error('EXPIRED:' + (errData.message || 'Session expired.'));
        }
        if (!streamRes.ok) {
            var errData = await streamRes.json().catch(function() { return {}; });
            throw new Error(errData.error || 'HTTP ' + streamRes.status);
        }

        // Parse SSE body â€” all chunks returned at once, we animate the assembly
        var responseText = await streamRes.text();
        var lines = responseText.split('\n');
        var chunks = [];
        var reportId = 'LL-REPORT';

        lines.forEach(function(line) {
            if (!line.startsWith('data: ')) return;
            try {
                var ev = JSON.parse(line.slice(6));
                if (ev.type === 'chunk') chunks.push(ev.text);
                if (ev.type === 'done') reportId = ev.reportId || reportId;
                if (ev.type === 'error') throw new Error(ev.message);
            } catch(e) {
                if (e.message && !e.message.includes('JSON')) throw e;
            }
        });

        if (chunks.length === 0) throw new Error('No report content received');

        // Store full HTML for download
        var fullHtml = chunks.join('');
        currentReportHtml = fullHtml;
        currentReportId   = reportId;

        // Animate assembly into RIGHT PANEL live iframe
        var segments = [];
        var segSize = 80;
        for (var i = 0; i < fullHtml.length; i += segSize) {
            segments.push(fullHtml.substring(i, i + segSize));
        }

        var liveFrame  = document.getElementById('liveFrame');
        var emptyState = document.getElementById('genRightEmpty');
        var assembled  = '';
        var segIdx     = 0;
        var frameVisible = false;

        await new Promise(function(resolve) {
            function writeNext() {
                if (segIdx >= segments.length) { resolve(); return; }

                assembled += segments[segIdx];
                segIdx++;

                // Update live iframe every 6 segments
                if (segIdx % 6 === 0 || segIdx === segments.length) {
                    // Once body is open, show the frame
                    if (!frameVisible && assembled.indexOf('<body') !== -1) {
                        frameVisible = true;
                        emptyState.classList.add('hidden');
                        liveFrame.srcdoc = assembled + '</body></html>';
                        setTimeout(function() { liveFrame.classList.add('visible'); }, 60);
                    } else if (frameVisible) {
                        liveFrame.srcdoc = assembled + '</body></html>';
                    }
                }

                // Drive pct from 88 â†’ 99 as segments write
                var segPct = 88 + Math.floor((segIdx / segments.length) * 11);
                if (segPct > currentPct) {
                    currentPct = segPct;
                    document.getElementById('genPct').textContent = Math.floor(currentPct) + '%';
                    document.getElementById('genBar').style.width = Math.floor(currentPct) + '%';
                }

                // Fast at start (CSS), steady through content
                var delay = segIdx < segments.length * 0.25 ? 3 : 10;
                setTimeout(writeNext, delay);
            }
            writeNext();
        });

        // Set final complete HTML
        liveFrame.srcdoc = fullHtml;

        // Snap ticker to 100%
        await completeTicker();

        // Close overlay â€” transition to main report view
        document.getElementById('genOverlay').classList.remove('active');
        document.body.classList.add('report-active');

        var mainFrame = document.getElementById('reportFrame');
        var container = document.getElementById('reportContainer');
        mainFrame.srcdoc = fullHtml;
        container.classList.add('active');

        // Size main iframe
        setTimeout(function() {
            try {
                var doc = mainFrame.contentDocument;
                var h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
                if (h > 100) mainFrame.style.height = (h + 32) + 'px';
            } catch(e) { mainFrame.style.height = '5000px'; }
        }, 800);

        window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (err) {
        stopTicker();
        document.getElementById('genOverlay').classList.remove('active');
        document.getElementById('formContainer').style.display = '';
        var msg = err.message || 'Unknown error';
        if (msg.startsWith('EXPIRED:')) {
            alert('â± ' + msg.replace('EXPIRED:', '') + '\n\nPlease re-upload â€” your payment intent is still valid.');
        } else {
            alert('Something went wrong.\n\nIf payment was taken, contact listinglens@upd8.group for a refund.\n\nError: ' + msg);
        }
        console.error(err);
    }
}

// Legacy poll function kept for reference but no longer called
async function pollForReport(jobId) {
    var maxAttempts = 60;
    for (var i = 0; i < maxAttempts; i++) {
        await new Promise(function(r) { setTimeout(r, 3000); });
        var res  = await fetch('/api/report-status?jobId=' + encodeURIComponent(jobId));
        var data = await res.json();
        if (data.status === 'complete') return { format: 'html', reportId: data.reportId, html: data.html };
        if (data.status === 'error') throw new Error(data.error || 'Report generation failed');
    }
    throw new Error('Report generation timed out. Please try again.');
}

// â”€â”€â”€ RENDER REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReport(r) {
    var container = document.getElementById('reportContainer');
    var frame     = document.getElementById('reportFrame');
    if (r.format === 'html' && r.html) {
        currentReportHtml = r.html;
        currentReportId   = r.reportId || 'LL-REPORT';
        frame.srcdoc      = r.html;
        frame.onload = function() {
            try {
                var doc = frame.contentDocument;
                doc.documentElement.style.overflow = 'hidden';
                doc.body.style.overflow = 'hidden';
                var h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
                if (h < 100) h = 4000;
                frame.style.height = (h + 32) + 'px';
            } catch (e) { frame.style.height = '4000px'; }
            setTimeout(function() {
                try {
                    var doc = frame.contentDocument;
                    var h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
                    if (h > 100) frame.style.height = (h + 32) + 'px';
                } catch (e) {}
            }, 500);
        };
    } else {
        currentReportHtml = '<html><body><pre style="padding:24px;font-family:monospace;font-size:13px;">' + esc(JSON.stringify(r, null, 2)) + '</pre></body></html>';
        currentReportId   = 'LL-REPORT';
        frame.srcdoc      = currentReportHtml;
        frame.style.height = '600px';
    }
    container.classList.add('active');
    document.body.classList.add('report-active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function downloadReport() {
    if (!currentReportHtml) return;
    var blob = new Blob([currentReportHtml], { type: 'text/html' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = currentReportId + '.html'; a.click();
    URL.revokeObjectURL(url);
}

function resetForm() {
    uploadedFiles = []; sessionId = null; selectedPrice = 200;
    stripe = null; elements = null; paymentElement = null;
    clientSecret = null; paymentIntentId = null;
    stripeInitialised = false; stripeInitialising = false; uploadInProgress = false;
    currentReportHtml = ''; currentReportId = '';
    fileList.innerHTML = '';
    uploadZone.style.display = '';
    document.getElementById('paymentSection').classList.remove('active');
    document.getElementById('betaSection').style.display = 'none';
    document.getElementById('payment-element').innerHTML = '';
    document.getElementById('payment-element').style.display = 'none';
    document.getElementById('payBtn').style.display = 'none';
    document.getElementById('paymentSecure').style.display = 'none';
    showPaymentLoading('Securing your screenshots...');
    hidePaymentError();
    document.getElementById('reportContainer').classList.remove('active');
    document.body.classList.remove('report-active');
    document.getElementById('reportFrame').srcdoc = '';
    document.getElementById('reportFrame').style.height = '';
    // Reset live frame and empty state
    var lf = document.getElementById('liveFrame');
    if (lf) { lf.srcdoc = ''; lf.classList.remove('visible'); }
    var es = document.getElementById('genRightEmpty');
    if (es) es.classList.remove('hidden');
    document.getElementById('formContainer').style.display = '';
    document.querySelectorAll('input[name="price"]').forEach(function(r) { r.checked = r.value === '200'; });
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
