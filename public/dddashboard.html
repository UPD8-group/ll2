\<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Listing Lens — Analyse a listing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060912; --white: #0c1428; --ink: #e8eaf0; --ink-sec: #9ca3af;
      --ink-muted: #5a6380; --border: rgba(255,255,255,0.09); --blue: #7BA7FF; --blue-mid: #5585f5;
      --blue-light: #3B6DE8; --blue-bg: rgba(59,109,232,0.12); --green: #4ade80;
      --amber: #fbbf24; --amber-bg: rgba(251,191,36,0.1); --red: #f87171; --red-bg: rgba(248,113,113,0.1);
      --radius: 12px; --font: 'Inter', -apple-system, sans-serif;
      --font-display: 'Space Grotesk', sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font); background: var(--bg); color: var(--ink); -webkit-font-smoothing: antialiased; min-height: 100vh; display: flex; flex-direction: column; }

    /* NAV */
    nav { position: sticky; top: 0; z-index: 100; background: rgba(12,15,26,0.96); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.07); padding: 0 32px; }
    .nav-inner { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 62px; }
    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #fff; }
    .logo-icon { width: 34px; height: 34px; background: var(--blue-light); border-radius: 9px; display: flex; align-items: center; justify-content: center; }
    .logo-icon svg { width: 18px; height: 18px; }
    .logo-text { font-family: var(--font-display); font-weight: 700; font-size: 17px; letter-spacing: -0.3px; color: #fff; }
    .nav-right { display: flex; align-items: center; gap: 24px; }
    .nav-badge { font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.3); border-left: 1px solid rgba(255,255,255,0.1); padding-left: 20px; }
    .nav-link { font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.5); text-decoration: none; transition: color 0.15s; }
    .nav-link:hover { color: rgba(255,255,255,0.9); }
    @media (max-width: 600px) { .nav-badge, .nav-link { display: none; } }

    /* LAYOUT */
    main { flex: 1; }
    .layout { max-width: 1100px; margin: 0 auto; padding: 28px 32px; display: grid; grid-template-columns: 280px minmax(0,1fr); gap: 20px; align-items: start; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    @media (max-width: 600px) { .layout { padding: 16px; } }

    /* SIDEBAR — IDLE */
    .sidebar { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: sticky; top: 82px; transition: background 0.4s, border-color 0.4s; }
    .sidebar-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 10px; }
    .divider { height: 1px; background: var(--border); margin: 16px 0; transition: background 0.4s; }
    .btn-scan { width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--blue-light); color: #fff; font-family: var(--font); font-size: 14px; font-weight: 700; padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; transition: background 0.15s; animation: pulse-ring 2.5s ease infinite; }
    .btn-scan:hover { background: #2d5fd4; }
    .btn-scan-sub { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.55); }
    @keyframes pulse-ring { 0%,100%{box-shadow:0 0 0 0 rgba(59,109,232,0.3)} 50%{box-shadow:0 0 0 8px rgba(59,109,232,0)} }
    .upload-hint { font-size: 12px; color: var(--ink-muted); line-height: 1.55; margin-top: 10px; }
    .case-list { display: flex; flex-direction: column; gap: 6px; max-height: 50vh; overflow-y: auto; }
    .case-item { padding: 10px 12px; border: 1px solid var(--border); border-radius: 9px; cursor: pointer; transition: all 0.15s; background: rgba(255,255,255,0.03); }
    .case-item:hover { border-color: var(--blue-light); background: rgba(59,109,232,0.15); }
    .case-item.active { border-color: var(--blue-light); background: rgba(59,109,232,0.18); box-shadow: 0 0 0 1px var(--blue-light); }
    .case-item-title { font-size: 12px; font-weight: 600; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .case-item-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--ink-muted); }
    .tip-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 9px; padding: 12px 14px; font-size: 12px; color: var(--ink-sec); line-height: 1.6; }
    .tip-box strong { display: block; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 5px; }

    /* SIDEBAR — SCANNING */
    .sidebar.scanning { background: #030609; border-color: rgba(255,255,255,0.08); }
    .sidebar.scanning .divider { background: rgba(255,255,255,0.08); }
    .sidebar.scanning .btn-scan { background: rgba(59,109,232,0.18); border: 1px solid rgba(59,109,232,0.25); animation: none; cursor: default; }
    .sidebar.scanning .sidebar-label { color: rgba(255,255,255,0.25); }
    .sidebar.scanning .upload-hint { color: rgba(255,255,255,0.25); }
    .sidebar.scanning .tip-box { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.07); color: rgba(255,255,255,0.3); }
    .sidebar.scanning .tip-box strong { color: rgba(255,255,255,0.18); }
    .sidebar.scanning .case-item { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.07); }
    .sidebar.scanning .case-item-title { color: rgba(255,255,255,0.5); }
    .sidebar.scanning .case-item-meta { color: rgba(255,255,255,0.25); }

    /* PROGRESS BLOCK */
    .progress-block { display: none; margin-bottom: 4px; }
    .sidebar.scanning .progress-block { display: block; }
    .sidebar.scanning .idle-content { display: none; }

    .progress-step-label { font-size: 11px; font-weight: 600; color: var(--blue-light); margin-bottom: 8px; min-height: 16px; transition: color 0.3s; }
    .progress-track { height: 2px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 18px; }
    .progress-fill { height: 2px; background: var(--blue-light); border-radius: 2px; width: 0%; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); }
    .progress-pct { font-family: var(--font-display); font-size: 56px; font-weight: 700; letter-spacing: -3px; color: #fff; line-height: 1; margin-bottom: 4px; }
    .progress-sub { font-size: 12px; color: rgba(255,255,255,0.35); margin-bottom: 22px; }

    .step-list { display: flex; flex-direction: column; gap: 11px; }
    .step-row { display: flex; align-items: flex-start; gap: 10px; }
    .step-ind {
      width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; margin-top: 1px;
      border: 1.5px solid rgba(255,255,255,0.12); color: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .step-ind.done { background: var(--blue-light); border-color: var(--blue-light); color: #fff; }
    .step-ind.active { background: rgba(59,109,232,0.15); border-color: var(--blue-light); color: var(--blue-light); animation: step-ring 1.6s ease infinite; }
    @keyframes step-ring { 0%,100%{box-shadow:0 0 0 0 rgba(59,109,232,0.3)} 50%{box-shadow:0 0 0 4px rgba(59,109,232,0)} }
    .step-txt { font-size: 12px; color: rgba(255,255,255,0.2); line-height: 1.45; padding-top: 2px; transition: color 0.3s; }
    .step-txt.done { color: rgba(255,255,255,0.5); }
    .step-txt.active { color: #fff; font-weight: 600; }
    .check-svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }

    /* REPORT PANEL */
    .report-panel { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; min-height: 60vh; display: flex; flex-direction: column; }
    .report-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
    .report-header-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 6px; }
    .report-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; color: var(--ink); letter-spacing: -0.3px; }
    .report-score-wrap { text-align: right; flex-shrink: 0; }
    .report-score-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 4px; }
    .report-score { font-family: var(--font-display); font-size: 36px; font-weight: 700; letter-spacing: -1px; color: var(--ink-muted); }
    .report-score.green  { color: #4ade80; }
    .report-score.yellow { color: #fbbf24; }
    .report-score.orange { color: #fb923c; }
    .report-score.red    { color: #f87171; }

    /* Error */
    .state-error { display: none; align-items: flex-start; gap: 10px; padding: 10px 14px; background: rgba(248,113,113,0.07); border: 1px solid rgba(248,113,113,0.18); border-radius: 9px; margin-bottom: 16px; font-size: 13px; color: #fca5a5; word-break: break-word; }

    /* Empty */
    .state-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 48px 24px; }
    .state-empty-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 12px; }
    .state-empty p { font-size: 14px; color: var(--ink-sec); line-height: 1.7; max-width: 380px; margin-bottom: 20px; }
    .btn-empty { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border: 1.5px solid rgba(255,255,255,0.15); border-radius: 100px; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); background: none; cursor: pointer; transition: all 0.15s; }
    .btn-empty:hover { border-color: var(--blue-light); color: #fff; }

    /* SKELETON */
    .skeleton-panel { display: none; flex: 1; flex-direction: column; }
    .skel-tags { margin-bottom: 20px; display: flex; gap: 6px; }
    .skel-tag { display: inline-block; padding: 3px 10px; border-radius: 5px; font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
    .skel-tag.blue { background: var(--blue-bg); color: var(--blue-light); }
    .skel-tag.muted { background: rgba(255,255,255,0.06); color: var(--ink-muted); border: 1px solid var(--border); }
    .skel-section { border-top: 1px solid var(--border); padding: 18px 0; transition: opacity 0.5s; }
    .skel-section:first-of-type { border-top: none; }
    .skel-num { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 14px; }
    .skel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 24px; }
    .skel-field-lbl { font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 6px; }
    .skel-field-val { font-size: 14px; font-weight: 600; color: var(--ink); }
    .skel-bar { height: 13px; background: rgba(255,255,255,0.08); border-radius: 4px; animation: shimmer 1.6s ease infinite; margin-top: 6px; }
    .skel-bar.s { width: 45%; } .skel-bar.m { width: 72%; } .skel-bar.l { width: 100%; }
    @keyframes shimmer { 0%,100%{opacity:0.55} 50%{opacity:1} }

    /* REPORT BODY */
    .report-body { display: none; flex: 1; flex-direction: column; gap: 20px; }
    .report-grid-2 { display: grid; grid-template-columns: 1.5fr 1fr; gap: 16px; }
    @media (max-width: 700px) { .report-grid-2 { grid-template-columns: 1fr; } }
    .report-section-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 8px; }
    .report-verdict { font-size: 14px; color: var(--ink-sec); line-height: 1.75; }
    .profile-box { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 9px; padding: 14px; }
    .profile-type { font-size: 13px; font-weight: 600; color: var(--ink); margin-bottom: 4px; }
    .profile-value { font-size: 12px; color: var(--ink-muted); line-height: 1.5; }
    .flags-questions { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 700px) { .flags-questions { grid-template-columns: 1fr; } }
    .flag-list, .question-list { display: flex; flex-direction: column; gap: 6px; }
    .flag-item { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #fca5a5; line-height: 1.5; }
    .flag-dot { width: 6px; height: 6px; border-radius: 50%; background: #f87171; flex-shrink: 0; margin-top: 5px; }
    .question-item { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: var(--ink-sec); line-height: 1.5; }
    .q-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--ink-muted); flex-shrink: 0; margin-top: 5px; }
    .list-empty { font-size: 12px; color: var(--ink-muted); font-style: italic; }
    .report-notes { font-size: 13px; color: var(--ink-sec); line-height: 1.7; }
    .report-footer { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 8px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--ink-muted); }
    .report-footer em { font-style: italic; }

    /* FOOTER */
    footer { padding: 24px 32px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    .footer-inner { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; font-size: 13px; color: var(--ink-muted); }
    .footer-links { display: flex; gap: 20px; }
    .footer-links a { color: var(--ink-muted); text-decoration: none; }
    .footer-links a:hover { color: var(--ink); }

    /* REPORT IFRAME */
    .report-iframe-wrap { display: none; flex: 1; flex-direction: column; }
    .report-iframe-wrap iframe { border: none; width: 100%; flex: 1; min-height: 72vh; border-radius: 8px; background: #fff; }
    .report-open-btn { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .btn-open-new { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.5); background: none; cursor: pointer; text-decoration: none; transition: all 0.15s; }
    .btn-open-new:hover { border-color: var(--blue-light); color: #fff; }

    /* TIER PICKER */
    .tier-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .tier-btn { flex: 1; padding: 9px 8px; border: 1.5px solid var(--border); border-radius: 9px; background: rgba(255,255,255,0.03); cursor: pointer; font-family: var(--font); text-align: center; transition: all 0.15s; }
    .tier-btn.active { border-color: var(--blue-light); background: rgba(59,109,232,0.12); }
    .tier-btn .tier-name { display: block; font-size: 12px; font-weight: 700; color: var(--ink); }
    .tier-btn .tier-price { display: block; font-size: 11px; color: var(--ink-muted); margin-top: 2px; }
    .tier-btn.active .tier-name { color: var(--blue-light); }

    /* PAYMENT */
    #payment-wrap { display: none; }
    #card-element { padding: 12px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }
    .btn-pay { width: 100%; padding: 12px; background: var(--blue-light); color: #fff; font-family: var(--font); font-size: 14px; font-weight: 700; border: none; border-radius: 9px; cursor: pointer; transition: background 0.15s; }
    .btn-pay:hover { background: #2d5fd4; }
    .btn-pay:disabled { opacity: 0.5; cursor: default; }

    /* FOOTER */
    footer { padding: 24px 32px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    .footer-inner { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; font-size: 13px; color: var(--ink-muted); }
    .footer-links { display: flex; gap: 20px; }
    .footer-links a { color: var(--ink-muted); text-decoration: none; }
    .footer-links a:hover { color: var(--ink); }
  </style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="/" class="logo">
      <div class="logo-icon"><svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg></div>
      <span class="logo-text">Listing Lens</span>
    </a>
    <div class="nav-right">
      <span class="nav-badge">Buyer's Dashboard</span>
      <a href="/" class="nav-link">← Back to home</a>
    </div>
  </div>
</nav>

<main>
  <div class="layout">

    <aside class="sidebar" id="sidebar">

      <!-- PROGRESS (scanning only) -->
      <div class="progress-block">
        <div class="progress-step-label" id="pg-label">Preparing…</div>
        <div class="progress-track"><div class="progress-fill" id="pg-bar"></div></div>
        <div class="progress-pct" id="pg-pct">0%</div>
        <div class="progress-sub">Analysing your listing</div>
        <div class="step-list" id="step-list"></div>
      </div>

      <!-- IDLE CONTENT -->
      <div class="idle-content">
        <div style="margin-bottom:14px">
          <div class="sidebar-label">Tier</div>
          <div class="tier-row">
            <button class="tier-btn active" id="tier-standard" onclick="selectTier('standard')">
              <span class="tier-name">Standard</span>
              <span class="tier-price">$2</span>
            </button>
            <button class="tier-btn" id="tier-deepdive" onclick="selectTier('deep-dive')">
              <span class="tier-name">Deep Dive</span>
              <span class="tier-price">$5</span>
            </button>
          </div>
        </div>
        <div style="margin-bottom:16px">
          <div class="sidebar-label">New scan</div>
          <button id="new-scan-btn" class="btn-scan">
            Start a new scan <span class="btn-scan-sub">Up to 4 images</span>
          </button>
          <p class="upload-hint">Screenshot the listing — price, description, spec table, and photo grid. Drop all screenshots together.</p>
        </div>
        <div id="payment-wrap">
          <div class="divider"></div>
          <div style="margin-bottom:12px">
            <div class="sidebar-label">Payment</div>
            <div id="card-element"></div>
            <button class="btn-pay" id="pay-btn">Pay &amp; Generate Report</button>
          </div>
        </div>
        <div class="divider"></div>
        <div style="margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <div class="sidebar-label" style="margin-bottom:0">My reports (this session)</div>
            <span id="case-count" style="font-size:11px;color:var(--ink-muted)">0</span>
          </div>
          <ul id="case-list" class="case-list"></ul>
        </div>
        <div class="divider"></div>
        <div class="tip-box">
          <strong>Tip</strong>
          Use one scan per serious candidate. Compare scores and red flags before you start booking inspections.
        </div>
      </div>

    </aside>

    <section class="report-panel">
      <div class="report-header">
        <div>
          <div class="report-header-label">Current report</div>
          <div id="report-title" class="report-title">No scan selected yet</div>
        </div>
        <div class="report-score-wrap">
          <div class="report-score-label">Lens score</div>
          <div id="report-score" class="report-score">--</div>
        </div>
      </div>

      <div id="error-state" class="state-error">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0"></span>
        <span id="error-text">Something went wrong.</span>
      </div>

      <!-- EMPTY -->
      <div id="empty-state" class="state-empty">
        <div class="state-empty-label">Ready when you are</div>
        <p>Start a new scan from the left panel. Upload up to four screenshots of a single listing — Joe gives you a mechanic-grade verdict, red flags, and the questions worth asking.</p>
        <button id="empty-state-btn" class="btn-empty">Start a new scan →</button>
      </div>

      <!-- SKELETON (while generating) -->
      <div id="skeleton-panel" class="skeleton-panel">
        <div class="skel-tags">
          <span class="skel-tag blue" id="skel-tag-type">Vehicle</span>
          <span class="skel-tag muted" id="skel-tag-status">Reading…</span>
        </div>
        <div class="skel-section">
          <div class="skel-num">01 — What this listing is</div>
          <div class="skel-grid">
            <div><div class="skel-field-lbl">Category</div><div class="skel-field-val" id="sk-cat"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-field-lbl">Listed by</div><div class="skel-field-val" id="sk-by"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-field-lbl">Location</div><div class="skel-field-val" id="sk-loc"><div class="skel-bar s"></div></div></div>
            <div><div class="skel-field-lbl">Listing price</div><div class="skel-field-val" id="sk-price"><div class="skel-bar s"></div></div></div>
          </div>
        </div>
        <div class="skel-section" id="sk2" style="opacity:0.2">
          <div class="skel-num">02 — Comparable sales &amp; market position</div>
          <div class="skel-bar l"></div><div class="skel-bar m"></div><div class="skel-bar s"></div>
        </div>
        <div class="skel-section" id="sk3" style="opacity:0.2">
          <div class="skel-num">03 — True first-year cost</div>
          <div class="skel-bar m"></div><div class="skel-bar l"></div>
        </div>
        <div class="skel-section" id="sk4" style="opacity:0.2">
          <div class="skel-num">04 — Red flags &amp; omission analysis</div>
          <div class="skel-bar l"></div><div class="skel-bar m"></div><div class="skel-bar s"></div>
        </div>
        <div class="skel-section" id="sk5" style="opacity:0.2">
          <div class="skel-num">05 — Closer questions</div>
          <div class="skel-bar m"></div><div class="skel-bar l"></div>
        </div>
        <div class="skel-section" id="sk6" style="opacity:0.2">
          <div class="skel-num">06 — Joe's verdict</div>
          <div class="skel-bar l"></div><div class="skel-bar l"></div><div class="skel-bar m"></div>
        </div>
      </div>

      <!-- FINAL REPORT — iframe -->
      <div id="report-iframe-wrap" class="report-iframe-wrap">
        <div class="report-open-btn">
          <a id="open-new-tab" class="btn-open-new" target="_blank">↗ Open in new tab</a>
          <span id="report-id-badge" style="font-size:11px;color:var(--ink-muted);margin-left:auto;"></span>
        </div>
        <iframe id="report-frame" title="Listing Lens Report" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
      </div>

    </section>

  </div>
</main>

<input id="file-input" type="file" accept="image/*" multiple style="display:none" />

<footer>
  <div class="footer-inner">
    <span>© 2026 Listing Lens · The UPD8 Group Pty Ltd</span>
    <div class="footer-links"><a href="/terms.html">Terms</a><a href="/privacy.html">Privacy</a></div>
  </div>
</footer>

<script>
  // ── ENDPOINTS (match real Netlify functions) ──
  const UPLOAD_URL     = '/api/upload-screenshots';
  const QUICK_URL      = '/api/quick-scan';
  const GENERATE_URL   = '/api/generate-report';
  const BACKGROUND_URL = '/.netlify/functions/stream-report-background';
  const STATUS_URL     = '/api/report-status';
  const CONFIG_URL     = '/api/config';
  const PAYMENT_URL    = '/api/create-payment';

  // ── PROGRESS STEPS ──
  const STEPS = [
    { label: "Scanning listing for observable data",          pct: 10 },
    { label: "Identifying listing type, platform & location", pct: 22 },
    { label: "Cross-referencing comparable sales & prices",   pct: 38 },
    { label: "Mapping what the listing omits",                pct: 54 },
    { label: "Calculating true cost of ownership",            pct: 68 },
    { label: "Compiling closer questions & leverage data",    pct: 82 },
    { label: "Assembling intelligence report",                pct: 95 },
  ];
  const STEP_TIMES = [1000, 2800, 5200, 8500, 13000, 18500, 25000];
  const SKEL_UNLOCK = { 1:"sk2", 2:"sk3", 3:"sk4", 4:"sk5", 5:"sk6" };

  // ── STATE ──
  let cases = [], currentCaseId = null, caseCounter = 1;
  let pgInterval = null, currentPct = 0, targetPct = 0;
  let stepTimers = [];
  let selectedTier = 'standard';
  let appConfig = { betaMode: false, stripePk: '' };
  let stripe = null, cardElement = null;
  let pendingSessionId = null, pendingJobId = null;

  const $ = id => document.getElementById(id);
  const sidebar      = $("sidebar");
  const stepListEl   = $("step-list");
  const pgPct        = $("pg-pct");
  const pgBar        = $("pg-bar");
  const pgLabel      = $("pg-label");
  const emptyState   = $("empty-state");
  const skelPanel    = $("skeleton-panel");
  const iframeWrap   = $("report-iframe-wrap");
  const reportFrame  = $("report-frame");
  const errorState   = $("error-state");
  const errorText    = $("error-text");
  const caseListEl   = $("case-list");
  const caseCountEl  = $("case-count");
  const reportTitle  = $("report-title");
  const reportScore  = $("report-score");
  const paymentWrap  = $("payment-wrap");

  // ── TIER ──
  function selectTier(t) {
    selectedTier = t;
    $("tier-standard").classList.toggle("active", t === "standard");
    $("tier-deepdive").classList.toggle("active", t === "deep-dive");
  }

  // ── CONFIG ──
  async function loadConfig() {
    try {
      const res = await fetch(CONFIG_URL);
      if (res.ok) appConfig = await res.json();
    } catch(e) { console.warn("Config load failed, assuming beta mode"); appConfig = { betaMode: true }; }
    if (!appConfig.betaMode && appConfig.stripePk) {
      initStripe(appConfig.stripePk);
    }
  }

  function initStripe(pk) {
    if (!window.Stripe) return;
    stripe = window.Stripe(pk);
    const elements = stripe.elements({ appearance: { theme: 'night' } });
    cardElement = elements.create('card', {
      style: { base: { color: '#e8eaf0', fontFamily: 'Inter, sans-serif', fontSize: '14px' } }
    });
    cardElement.mount('#card-element');
    paymentWrap.style.display = 'block';
    $("pay-btn").addEventListener("click", handlePayment);
  }

  async function handlePayment() {
    if (!stripe || !cardElement || !pendingSessionId) return;
    const amountMap = { 'standard': 200, 'deep-dive': 500 };
    const amount = amountMap[selectedTier] || 200;
    try {
      $("pay-btn").disabled = true;
      $("pay-btn").textContent = "Creating payment…";
      const res = await fetch(PAYMENT_URL, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ amount })
      });
      const payment = await res.json();
      const { error, paymentIntent } = await stripe.confirmCardPayment(payment.clientSecret, {
        payment_method: { card: cardElement }
      });
      if (error) throw new Error(error.message);
      // Payment done — now generate
      paymentWrap.style.display = 'none';
      await startReportGeneration(pendingSessionId, paymentIntent.id);
    } catch(e) {
      $("pay-btn").disabled = false;
      $("pay-btn").textContent = "Pay & Generate Report";
      showError("Payment failed: " + (e.message || "Unknown error"));
    }
  }

  // ── PROGRESS ──
  function buildSteps() {
    stepListEl.innerHTML = "";
    STEPS.forEach((s, i) => {
      stepListEl.insertAdjacentHTML("beforeend", `
        <div class="step-row">
          <div class="step-ind" id="si${i}">${i+1}</div>
          <div class="step-txt" id="st${i}">${s.label}</div>
        </div>`);
    });
  }

  function setStep(i, state) {
    const ind = $(`si${i}`), txt = $(`st${i}`);
    if (!ind) return;
    ind.className = "step-ind" + (state==="done" ? " done" : state==="active" ? " active" : "");
    txt.className = "step-txt" + (state==="done" ? " done" : state==="active" ? " active" : "");
    ind.innerHTML = state === "done"
      ? `<svg class="check-svg" viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg>`
      : (i+1).toString();
  }

  function startProgress() {
    buildSteps();
    currentPct = 0; targetPct = 0;
    pgPct.textContent = "0%";
    pgBar.style.width = "0%";
    pgLabel.textContent = STEPS[0].label;
    pgInterval = setInterval(() => {
      if (currentPct < targetPct) {
        currentPct = Math.min(currentPct + 1, targetPct);
        pgPct.textContent = currentPct + "%";
        pgBar.style.width = currentPct + "%";
      }
    }, 60);
    STEP_TIMES.forEach((t, i) => {
      const timer = setTimeout(() => {
        if (!sidebar.classList.contains("scanning")) return;
        if (i > 0) setStep(i - 1, "done");
        setStep(i, "active");
        targetPct = STEPS[i].pct;
        pgLabel.textContent = STEPS[i].label;
        if (SKEL_UNLOCK[i]) { const el = $(SKEL_UNLOCK[i]); if (el) el.style.opacity = "1"; }
      }, t);
      stepTimers.push(timer);
    });
  }

  function finishProgress(cb) {
    STEPS.forEach((_, i) => setStep(i, "done"));
    pgLabel.textContent = "Complete";
    ["sk2","sk3","sk4","sk5","sk6"].forEach(id => { const el=$(id); if(el) el.style.opacity="1"; });
    targetPct = 100;
    const done = setInterval(() => {
      if (currentPct < 100) {
        currentPct = Math.min(currentPct + 3, 100);
        pgPct.textContent = currentPct + "%";
        pgBar.style.width = currentPct + "%";
      } else { clearInterval(done); setTimeout(cb, 350); }
    }, 25);
  }

  function stopProgress() {
    if (pgInterval) { clearInterval(pgInterval); pgInterval = null; }
    stepTimers.forEach(clearTimeout); stepTimers = [];
    sidebar.classList.remove("scanning");
  }

  // ── STATE HELPERS ──
  function showError(msg) {
    if (!msg) { errorState.style.display = "none"; return; }
    const clean = msg.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim().slice(0, 200);
    errorText.textContent = clean;
    errorState.style.display = "flex";
  }

  function resetView() {
    stopProgress();
    showError("");
    emptyState.style.display    = "flex";
    skelPanel.style.display     = "none";
    iframeWrap.style.display    = "none";
    reportFrame.srcdoc          = "";
    reportTitle.textContent     = "No scan selected yet";
    reportScore.textContent     = "--";
    reportScore.className       = "report-score";
  }

  // ── UPLOAD ──
  async function uploadFiles(files) {
    const fd = new FormData();
    Array.from(files).slice(0, 4).forEach(f => fd.append("screenshot", f));
    const res = await fetch(UPLOAD_URL, { method: "POST", body: fd });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(t.replace(/<[^>]*>/g,"").trim().slice(0,120) || `Upload failed (${res.status})`);
    }
    return res.json(); // { sessionId, screenshotCount }
  }

  // ── QUICK SCAN ──
  async function runQuickScan(sessionId) {
    try {
      const res = await fetch(QUICK_URL, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, tier: selectedTier })
      });
      if (!res.ok) return null;
      return res.json();
    } catch { return null; }
  }

  function applyQuickScan(qs) {
    if (!qs) return;
    if (qs.category) {
      $("skel-tag-type").textContent = qs.category;
      $("sk-cat").textContent = qs.category;
    }
    if (qs.price)    $("sk-price").textContent = qs.price;
    if (qs.location) $("sk-loc").textContent   = qs.location;
    if (qs.seller_type) $("sk-by").textContent = qs.seller_type;
    if (qs.title)    $("skel-tag-status").textContent = qs.title.slice(0, 40);
    $("sk2").style.opacity = "1";
  }

  // ── GENERATE ──
  async function generateReport(sessionId) {
    const res = await fetch(GENERATE_URL, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    });
    if (!res.ok) throw new Error("Session validation failed — please try again");
    return res.json(); // { jobId }
  }

  // ── BACKGROUND ──
  function kickBackground(sessionId, jobId, paymentIntentId) {
    // Fire-and-forget — Netlify returns 202 immediately, keeps running
    fetch(BACKGROUND_URL, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, jobId, paymentIntentId: paymentIntentId || null })
    }).catch(() => {});
  }

  // ── POLL ──
  function pollStatus(jobId) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const max = 120; // 6 minutes
      const iv = setInterval(async () => {
        attempts++;
        if (attempts > max) {
          clearInterval(iv);
          reject(new Error("Report timed out — please try again"));
          return;
        }
        try {
          const res = await fetch(`${STATUS_URL}?jobId=${jobId}`);
          const job = await res.json();
          if (job.status === "complete") { clearInterval(iv); resolve(job); }
          else if (job.status === "error") { clearInterval(iv); reject(new Error(job.error || "Report generation failed")); }
        } catch(e) { /* keep polling */ }
      }, 3000);
    });
  }

  // ── DISPLAY REPORT ──
  function showReport(html, reportId, title) {
    emptyState.style.display = "none";
    skelPanel.style.display  = "none";
    iframeWrap.style.display = "flex";
    reportFrame.srcdoc = html;

    // Open in new tab: create a blob URL
    const blob = new Blob([html], { type: "text/html" });
    const url  = URL.createObjectURL(blob);
    $("open-new-tab").href = url;
    $("report-id-badge").textContent = reportId || "";
    reportTitle.textContent = title || "Report ready";
    reportScore.textContent = "✓";
    reportScore.className   = "report-score green";
  }

  // ── CASE LIST ──
  function renderCases() {
    caseListEl.innerHTML = "";
    cases.forEach(c => {
      const li = document.createElement("li");
      li.className = "case-item" + (c.id === currentCaseId ? " active" : "");
      li.innerHTML = `<div class="case-item-title">${c.title}</div>
        <div class="case-item-meta"><span>${c.tier}</span><span>${c.shortTime}</span></div>`;
      li.addEventListener("click", () => selectCase(c.id));
      caseListEl.appendChild(li);
    });
    caseCountEl.textContent = cases.length;
  }

  function selectCase(id) {
    const c = cases.find(x => x.id === id);
    if (!c) return;
    currentCaseId = id;
    renderCases();
    showReport(c.html, c.reportId, c.title);
  }

  // ── MAIN SCAN FLOW ──
  async function startReportGeneration(sessionId, paymentIntentId) {
    try {
      // Step 1: get jobId
      const { jobId } = await generateReport(sessionId);
      pendingJobId = jobId;

      // Step 2: kick background (fire and forget)
      kickBackground(sessionId, jobId, paymentIntentId);

      // Step 3: run quick scan in parallel to populate skeleton
      runQuickScan(sessionId).then(qs => applyQuickScan(qs));

      // Step 4: poll until done
      const job = await pollStatus(jobId);

      // Step 5: display
      finishProgress(() => {
        stopProgress();
        const now = new Date();
        const nc = {
          id: `case-${caseCounter++}`,
          title: job.reportId || "Report",
          reportId: job.reportId,
          html: job.html,
          tier: selectedTier,
          shortTime: now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        };
        cases.unshift(nc);
        currentCaseId = nc.id;
        renderCases();
        showReport(job.html, job.reportId, job.reportId || "Report ready");
      });

    } catch(err) {
      console.error("Report generation error:", err);
      stopProgress();
      showError(err?.message || "Analysis failed. Please try again.");
      emptyState.style.display = "flex";
      skelPanel.style.display  = "none";
    }
  }

  async function handleScan(files) {
    if (!files || !files.length) return;
    showError("");
    emptyState.style.display = "none";
    iframeWrap.style.display = "none";
    skelPanel.style.display  = "flex";
    ["sk2","sk3","sk4","sk5","sk6"].forEach(id => { const el=$(id); if(el) el.style.opacity="0.2"; });
    $("skel-tag-type").textContent   = selectedTier === "deep-dive" ? "Deep Dive" : "Vehicle";
    $("skel-tag-status").textContent = "Reading…";
    ["sk-cat","sk-by","sk-loc","sk-price"].forEach(id => { const el=$(id); if(el) el.innerHTML='<div class="skel-bar s"></div>'; });

    sidebar.classList.add("scanning");
    startProgress();

    try {
      // Upload first
      const { sessionId } = await uploadFiles(files);
      pendingSessionId = sessionId;

      if (appConfig.betaMode) {
        // Skip payment — go straight to report
        await startReportGeneration(sessionId, null);
      } else {
        // Show payment form — user clicks Pay to continue
        stopProgress();
        sidebar.classList.remove("scanning");
        emptyState.style.display = "none";
        paymentWrap.style.display = "block";
        $("pay-btn").disabled = false;
        $("pay-btn").textContent = `Pay & Generate Report`;
        // Re-show sidebar idle content so user sees payment form
        sidebar.classList.remove("scanning");
        // Put skeleton back as placeholder
        skelPanel.style.display = "flex";
        showError("");
        reportTitle.textContent = "Complete payment to generate report";
      }
    } catch(err) {
      console.error("Upload error:", err);
      stopProgress();
      showError(err?.message || "Upload failed. Please try again.");
      emptyState.style.display = "flex";
      skelPanel.style.display  = "none";
    }
  }

  // ── INIT ──
  document.addEventListener("DOMContentLoaded", async () => {
    resetView();
    await loadConfig();

    const startNewScan = () => {
      showError("");
      $("file-input").value = "";
      $("file-input").click();
    };
    $("new-scan-btn").addEventListener("click", startNewScan);
    $("empty-state-btn").addEventListener("click", startNewScan);
    $("file-input").addEventListener("change", e => {
      if (e.target.files && e.target.files.length) handleScan(e.target.files);
    });
  });
</script>
</body>
</html>
